## **EA開発 要件定義（最終確定版）**

### **1\. 目的**

* 外国為替証拠金取引（FX）市場を対象とした自動売買システム（EA）を開発する。  
* 複数の時間軸における市場の「優勢」を判断し、有利な方向へエントリーすることを目的とする。

### **2\. 戦略概要**

* **コア戦略:** 添付ファイル記載の「PowerX Strategy」を基本とする 。  
  * **使用インジケーターとデフォルトパラメータ:**  
    * RSI (期間: 7\)  
    * Stochastic (%K 期間: 14, Smooth 期間: 3\)  
    * MACD (Fast期間: 12, Slow期間: 26, Signal期間: 9\)  
    * SuperTrend (期間: 10, 乗数: 4.0)  
    * ATR (期間: 14\) \- SL/TP計算用  
  * **シグナル:** Green Bar (買い条件), Red Bar (売り条件), Black Bar (中立)。各時間足でのシグナル判定時に、上位足RSIフィルターとSuperTrendフィルターの条件も加味する（詳細は「4. エントリー条件」参照）。  
* **マルチタイムフレーム分析:**  
  * 指定された複数の時間軸（1分足～1ヶ月足の範囲）で、個別に上記コア戦略のシグナル（フィルター条件込み）を判定する。  
* **優勢判断（重み付け考慮）:**  
  * 各監視対象時間軸のシグナルに対し、個別に設定された「重み」を適用する。  
  * 買い（ロング）優勢: Green Barが点灯している時間軸の重みの合計値が、設定した閾値以上になった場合。  
  * 売り（ショート）優勢: Red Barが点灯している時間軸の重みの合計値が、設定した閾値以上になった場合。  
* **エントリー:** 優勢判断に基づき、パラメータで選択されたエントリー方向（ロングのみ/ショートのみ/両方）に従って、成行注文でエントリーを実行する。  
* **資金管理:** 「基本分解モンテカルロ法」または「単一ロット」から選択する。  
* **フィルター:** ボラティリティフィルターを適用可能とする。

### **3\. 使用時間軸**

* **監視対象:** 1分足、5分足、15分足、30分足、1時間足、4時間足、日足、週足、月足の中から、バックテスト等で有効性を検証し、選択した複数の時間軸を使用する。  
  * 各時間軸には個別の「重み」を設定する。  
* **上位時間足:** トレンドフィルター用に、別途上位時間足（デフォルト: '60'）を指定する 。

### **4\. エントリー条件**

* **エントリー方向:** パラメータで「ロングのみ」「ショートのみ」「両方」から選択する。  
* **優勢度の計算:**  
  * **各時間足でのシグナル判定:** 監視対象の各時間軸で、以下の条件に基づき「Green Bar (買い)」「Red Bar (売り)」「Black Bar (中立)」を判定する。  
    * **Green Bar:** 当該時間足で (RSI \> 50 かつ Stoch \> 50 かつ MACDヒストグラム \> 0\) **かつ** 上位時間足のRSI \> 50 **かつ** SuperTrendが上昇トレンド 。  
    * **Red Bar:** 当該時間足で (RSI \< 50 かつ Stoch \< 50 かつ MACDヒストグラム \< 0\) **かつ** 上位時間足のRSI \< 50 **かつ** SuperTrendが下降トレンド 。  
    * **Black Bar:** 上記以外 。  
  * **重み付け:** 各時間足のシグナル判定結果に、パラメータで設定された「重み」を掛け合わせます。  
  * **優勢度の算出:**  
    * 買い優勢度 \= Green Barが出ている時間軸の重みの合計値。  
    * 売り優勢度 \= Red Barが出ている時間軸の重みの合計値。  
* **エントリー実行の判断:**  
  * **閾値判定:**  
    * 「買い優勢度」が、パラメータで設定された「ロング優勢判断の閾値」を超えた場合 ⇒ 買いエントリーの条件成立。  
    * 「売り優勢度」が、パラメータで設定された「ショート優勢判断の閾値」を超えた場合 ⇒ 売りエントリーの条件成立。  
  * **ボラティリティフィルター（パラメータで有効/無効を設定）:**  
    * フィルターが有効な場合、指定した時間軸のATR（期間もパラメータで設定）が、設定した閾値を超えていたらエントリーしません。  
  * **最終的なエントリー実行:**  
    * 選択されたエントリー方向と一致し、  
    * 優勢度の閾値を満たし、  
    * ボラティリティフィルターを通過した場合に、  
    * **成行注文**でエントリーします。

### **5\. 決済条件**

以下の決済ロジックは、それぞれパラメータで**有効/無効を選択可能**です。有効にしたロジックのうち、いずれかの条件が最初に満たされた時点で決済されます。

* **優勢の逆転による決済:**  
  * ロングポジション保有中に、「買い優勢度」が「売り優勢度」**以下**になったら決済。 (買い \<= 売り)  
  * ショートポジション保有中に、「売り優勢度」が「買い優勢度」**以下**になったら決済。 (売り \<= 買い)  
* **SL/TPによる決済:**  
  * エントリー時に設定された損切り（Stop Loss）または利確（Take Profit）の価格に到達したら決済 。  
    * SL価格 \= エントリー価格 \- ATR \* SL倍率 (ロング) / エントリー価格 \+ ATR \* SL倍率 (ショート)  
    * TP価格 \= エントリー価格 \+ ATR \* TP倍率 (ロング) / エントリー価格 \- ATR \* TP倍率 (ショート)

### **6\. 資金管理**

パラメータ設定により、以下のいずれかの資金管理方法を選択する。

* **基本分解モンテカルロ法:**  
  * 添付ファイルのPine Scriptコードに記載されたロジックに基づき、実装する 。  
  * トレードの勝敗に応じて注文数量を計算する 。  
  * **初期ベット額は 1.0 で固定。**  
  * **初期数列は \[0, 1\] で固定。**  
* **単一ロット（固定ロット）:**  
  * パラメータで指定された固定のロット数で常にエントリーする。

### **7\. パラメータ（EA設定画面で変更可能にする項目）**

* **基本設定:**  
  * マジックナンバー  
  * 対象通貨ペア（指定しない場合はEA適用チャートの通貨ペア）  
  * 許容スリッページ  
* **時間軸設定:**  
  * 監視対象とする時間軸のリスト（複数選択可能）  
  * 各監視対象時間軸の重み (例: M1=0.5, M5=1.0, H1=2.0 ...)  
  * 上位時間足（フィルター用、デフォルト: '60'）  
* **エントリー設定:**  
  * エントリー方向（「ロングのみ」「ショートのみ」「両方」から選択）  
  * ロング優勢判断の閾値（重み合計値）  
  * ショート優勢判断の閾値（重み合計値）  
* **エグジット設定:**  
  * 優勢の逆転による決済を有効にする (true/false)  
  * SL/TPによる決済を有効にする (true/false)  
  * Stop Loss ATR倍率 (デフォルト: 1.5)  
  * Profit Target ATR倍率 (デフォルト: 3.0)  
* **インジケーター設定:**  
  * RSI期間 (デフォルト: 7\)  
  * Stoch %K期間 (デフォルト: 14\)  
  * Stoch Smooth期間 (デフォルト: 3\)  
  * MACD Fast期間 (デフォルト: 12\)  
  * MACD Slow期間 (デフォルト: 26\)  
  * MACD Signal期間 (デフォルト: 9\)  
  * SuperTrend 期間 (デフォルト: 10\)  
  * SuperTrend 乗数 (デフォルト: 4.0)  
  * ATR 期間（SL/TP計算、ボラティリティフィルター用、デフォルト: 14）  
* **フィルター設定:**  
  * ボラティリティフィルターを有効にする (true/false)  
  * ボラティリティ指標（ATR）の対象時間軸  
  * ボラティリティ指標（ATR）の期間（インジケーター設定のATR期間と共通）  
  * ボラティリティの閾値（この値を超えたらエントリーしない）  
* **資金管理設定:**  
  * 資金管理方法（「モンテカルロ法」または「単一ロット」を選択）  
  * （単一ロット選択時）ロット数

### **8\. その他**

* **ログ出力:** エントリー、決済、エラーなどの情報をログファイルに出力する機能。  
* **表示機能:**（オプション）チャート上に現在の各時間軸のシグナル状況や優勢度（重み合計値）、モンテカルロ法の状態などを表示する機能。

以上で、初期バージョンとして開発するEAの要件定義が確定しました。 この内容に基づいて開発を進めることができます。もし追加や修正があればお知らせください。なければ、これで要件定義は完了といたします。